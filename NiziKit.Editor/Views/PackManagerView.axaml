<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:NiziKit.Editor.ViewModels"
             xmlns:views="using:NiziKit.Editor.Views"
             x:Class="NiziKit.Editor.Views.PackManagerView"
             x:DataType="vm:PackManagerViewModel">

    <Panel>
    <Grid ColumnDefinitions="160,*">
        <!-- Left: Pack List -->
        <Border Grid.Column="0"
                Background="#18FFFFFF"
                Padding="8"
                Margin="0,0,4,0">
            <Grid RowDefinitions="Auto,*,Auto">
                <TextBlock Grid.Row="0"
                           Text="Packs"
                           Classes="section-header"
                           Margin="4,0,0,8"/>

                <ListBox Grid.Row="1"
                         ItemsSource="{Binding Packs}"
                         SelectedItem="{Binding SelectedPack}"
                         Background="Transparent">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:PackInfo">
                            <StackPanel Spacing="1" Margin="4,2">
                                <TextBlock Text="{Binding Name}"
                                           FontWeight="Medium"
                                           FontSize="{DynamicResource EditorFontSizeSmall}"/>
                                <TextBlock Text="{Binding Version}"
                                           Classes="muted"
                                           FontSize="20"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                    <ListBox.Styles>
                        <Style Selector="ListBoxItem">
                            <Setter Property="Padding" Value="4,2"/>
                            <Setter Property="CornerRadius" Value="3"/>
                        </Style>
                    </ListBox.Styles>
                </ListBox>

                <StackPanel Grid.Row="2"
                            Orientation="Horizontal"
                            Spacing="4"
                            Margin="0,8,0,0">
                    <Button Content="New"
                            Command="{Binding NewPackCommand}"
                            Classes="ghost"
                            Padding="8,4"
                            FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    <Button Command="{Binding RefreshPacksCommand}"
                            Classes="ghost"
                            Padding="6,4">
                        <PathIcon Data="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                                  Width="14" Height="14"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Right: Pack Editor -->
        <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto" IsVisible="{Binding IsEditing}">
            <!-- Header: Pack Info -->
            <Border Grid.Row="0"
                    Background="#18FFFFFF"
                    Padding="12,8"
                    Margin="0,0,0,4">
                <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                    <TextBox Grid.Column="0"
                             Text="{Binding PackName}"
                             Watermark="Pack Name"
                             MinWidth="200"
                             FontSize="{DynamicResource EditorFontSizeSmall}"/>

                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                Spacing="8"
                                VerticalAlignment="Center">
                        <TextBlock Text="v"
                                   Classes="muted"
                                   VerticalAlignment="Center"/>
                        <TextBox Text="{Binding PackVersion}"
                                 Watermark="1.0.0"
                                 Width="80"
                                 FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </StackPanel>

                    <Button Grid.Column="4"
                            Content="Save"
                            Command="{Binding SavePackCommand}"
                            Classes="primary"
                            Padding="16,6"
                            Margin="12,0,0,0"
                            FontSize="{DynamicResource EditorFontSizeSmall}"/>
                </Grid>
            </Border>

            <!-- Asset Tabs -->
            <TabControl Grid.Row="1"
                        SelectedIndex="{Binding SelectedTabIndex}">
                <TabControl.Styles>
                    <Style Selector="TabItem">
                        <Setter Property="FontSize" Value="{DynamicResource EditorFontSizeSmall}"/>
                        <Setter Property="Padding" Value="16,8"/>
                    </Style>
                </TabControl.Styles>

                <!-- Textures Tab -->
                <TabItem Header="Textures">
                    <Grid RowDefinitions="*,Auto">
                        <ScrollViewer Grid.Row="0"
                                      HorizontalScrollBarVisibility="Disabled"
                                      VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding Textures}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:PackAssetEntry">
                                        <Border Width="140" Height="100"
                                                Margin="4"
                                                Padding="8"
                                                CornerRadius="4"
                                                Background="#20FFFFFF">
                                            <Grid RowDefinitions="*,Auto,Auto">
                                                <PathIcon Grid.Row="0"
                                                          Data="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"
                                                          Width="28" Height="28"
                                                          Foreground="{DynamicResource TextSecondaryBrush}"
                                                          VerticalAlignment="Center"
                                                          HorizontalAlignment="Center"/>
                                                <TextBlock Grid.Row="1"
                                                           Text="{Binding Key}"
                                                           TextTrimming="CharacterEllipsis"
                                                           TextAlignment="Center"
                                                           FontSize="20"
                                                           ToolTip.Tip="{Binding Key}"
                                                           Margin="0,4,0,0"/>
                                                <Button Grid.Row="2"
                                                        Content="Remove"
                                                        Classes="ghost"
                                                        FontSize="18"
                                                        Padding="4,2"
                                                        HorizontalAlignment="Center"
                                                        Command="{Binding $parent[ItemsControl].DataContext.RemoveTextureCommand}"
                                                        CommandParameter="{Binding}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <StackPanel Grid.Row="1"
                                    Orientation="Horizontal"
                                    Spacing="8"
                                    Margin="8">
                            <Button Content="+ Add Texture"
                                    Command="{Binding BrowseTextureCommand}"
                                    Classes="ghost"
                                    FontSize="{DynamicResource EditorFontSizeSmall}"/>
                        </StackPanel>
                    </Grid>
                </TabItem>

                <!-- Materials Tab -->
                <TabItem Header="Materials">
                    <Grid RowDefinitions="*,Auto">
                        <ScrollViewer Grid.Row="0"
                                      HorizontalScrollBarVisibility="Disabled"
                                      VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding Materials}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:PackAssetEntry">
                                        <Border Width="140" Height="100"
                                                Margin="4"
                                                Padding="8"
                                                CornerRadius="4"
                                                Background="#20FFFFFF"
                                                DoubleTapped="OnAssetCardDoubleTapped"
                                                Tag="{Binding}">
                                            <Grid RowDefinitions="*,Auto,Auto">
                                                <PathIcon Grid.Row="0"
                                                          Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93s3.05-7.44 7-7.93v15.86zm2-15.86c1.03.13 2 .45 2.87.93H13v-.93zM13 7h5.24c.25.31.48.65.68 1H13V7zm0 3h6.74c.08.33.15.66.19 1H13v-1zm0 9.93V19h2.87c-.87.48-1.84.8-2.87.93zM18.24 17H13v-1h5.92c-.2.35-.43.69-.68 1zm1.5-3H13v-1h6.93c-.04.34-.11.67-.19 1z"
                                                          Width="28" Height="28"
                                                          Foreground="{DynamicResource TextSecondaryBrush}"
                                                          VerticalAlignment="Center"
                                                          HorizontalAlignment="Center"/>
                                                <TextBlock Grid.Row="1"
                                                           Text="{Binding Key}"
                                                           TextTrimming="CharacterEllipsis"
                                                           TextAlignment="Center"
                                                           FontSize="20"
                                                           ToolTip.Tip="{Binding Key}"
                                                           Margin="0,4,0,0"/>
                                                <Button Grid.Row="2"
                                                        Content="Remove"
                                                        Classes="ghost"
                                                        FontSize="18"
                                                        Padding="4,2"
                                                        HorizontalAlignment="Center"
                                                        Command="{Binding $parent[ItemsControl].DataContext.RemoveMaterialCommand}"
                                                        CommandParameter="{Binding}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <StackPanel Grid.Row="1"
                                    Orientation="Horizontal"
                                    Spacing="8"
                                    Margin="8">
                            <Button Content="+ Add Material"
                                    Command="{Binding BrowseMaterialCommand}"
                                    Classes="ghost"
                                    FontSize="{DynamicResource EditorFontSizeSmall}"/>
                            <Button Content="+ Create New"
                                    Command="{Binding CreateMaterialCommand}"
                                    Classes="ghost"
                                    FontSize="{DynamicResource EditorFontSizeSmall}"/>
                        </StackPanel>
                    </Grid>
                </TabItem>

                <!-- Models Tab -->
                <TabItem Header="Models">
                    <Grid RowDefinitions="*,Auto">
                        <ScrollViewer Grid.Row="0"
                                      HorizontalScrollBarVisibility="Disabled"
                                      VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding Models}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:PackAssetEntry">
                                        <Border Width="140" Height="100"
                                                Margin="4"
                                                Padding="8"
                                                CornerRadius="4"
                                                Background="#20FFFFFF">
                                            <Grid RowDefinitions="*,Auto,Auto">
                                                <PathIcon Grid.Row="0"
                                                          Data="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
                                                          Width="28" Height="28"
                                                          Foreground="{DynamicResource TextSecondaryBrush}"
                                                          VerticalAlignment="Center"
                                                          HorizontalAlignment="Center"/>
                                                <TextBlock Grid.Row="1"
                                                           Text="{Binding Key}"
                                                           TextTrimming="CharacterEllipsis"
                                                           TextAlignment="Center"
                                                           FontSize="20"
                                                           ToolTip.Tip="{Binding Key}"
                                                           Margin="0,4,0,0"/>
                                                <Button Grid.Row="2"
                                                        Content="Remove"
                                                        Classes="ghost"
                                                        FontSize="18"
                                                        Padding="4,2"
                                                        HorizontalAlignment="Center"
                                                        Command="{Binding $parent[ItemsControl].DataContext.RemoveModelCommand}"
                                                        CommandParameter="{Binding}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <StackPanel Grid.Row="1"
                                    Orientation="Horizontal"
                                    Spacing="8"
                                    Margin="8">
                            <Button Content="+ Add Model"
                                    Command="{Binding BrowseModelCommand}"
                                    Classes="ghost"
                                    FontSize="{DynamicResource EditorFontSizeSmall}"/>
                        </StackPanel>
                    </Grid>
                </TabItem>

                <!-- Shaders Tab -->
                <TabItem Header="Shaders">
                    <Grid RowDefinitions="*,Auto">
                        <ScrollViewer Grid.Row="0"
                                      HorizontalScrollBarVisibility="Disabled"
                                      VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding Shaders}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:PackAssetEntry">
                                        <Border Width="140" Height="100"
                                                Margin="4"
                                                Padding="8"
                                                CornerRadius="4"
                                                Background="#20FFFFFF"
                                                DoubleTapped="OnAssetCardDoubleTapped"
                                                Tag="{Binding}">
                                            <Grid RowDefinitions="*,Auto,Auto">
                                                <PathIcon Grid.Row="0"
                                                          Data="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"
                                                          Width="28" Height="28"
                                                          Foreground="{DynamicResource TextSecondaryBrush}"
                                                          VerticalAlignment="Center"
                                                          HorizontalAlignment="Center"/>
                                                <TextBlock Grid.Row="1"
                                                           Text="{Binding Key}"
                                                           TextTrimming="CharacterEllipsis"
                                                           TextAlignment="Center"
                                                           FontSize="20"
                                                           ToolTip.Tip="{Binding Key}"
                                                           Margin="0,4,0,0"/>
                                                <Button Grid.Row="2"
                                                        Content="Remove"
                                                        Classes="ghost"
                                                        FontSize="18"
                                                        Padding="4,2"
                                                        HorizontalAlignment="Center"
                                                        Command="{Binding $parent[ItemsControl].DataContext.RemoveShaderCommand}"
                                                        CommandParameter="{Binding}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <StackPanel Grid.Row="1"
                                    Orientation="Horizontal"
                                    Spacing="8"
                                    Margin="8">
                            <Button Content="+ Add Shader"
                                    Command="{Binding BrowseShaderCommand}"
                                    Classes="ghost"
                                    FontSize="{DynamicResource EditorFontSizeSmall}"/>
                            <Button Content="+ Create New"
                                    Command="{Binding CreateShaderCommand}"
                                    Classes="ghost"
                                    FontSize="{DynamicResource EditorFontSizeSmall}"/>
                        </StackPanel>
                    </Grid>
                </TabItem>
            </TabControl>

            <!-- Status Bar -->
            <Border Grid.Row="2"
                    Background="#10FFFFFF"
                    Padding="12,6"
                    IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                <TextBlock Text="{Binding StatusMessage}"
                           Classes="muted"
                           FontSize="20"/>
            </Border>
        </Grid>

        <!-- No Selection Placeholder -->
        <Border Grid.Column="1"
                IsVisible="{Binding !IsEditing}">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="8">
                <PathIcon Data="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"
                          Width="48" Height="48"
                          Foreground="{DynamicResource TextMutedBrush}"/>
                <TextBlock Text="Select a pack or create a new one"
                           Classes="muted"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>

    <!-- File Browser Overlay -->
    <Border IsVisible="{Binding IsFileBrowserOpen}"
            Background="#C0000000">
        <Border Background="#E0202020"
                CornerRadius="8"
                BorderBrush="{DynamicResource PanelBorderBrush}"
                BorderThickness="1"
                Padding="16"
                Margin="40"
                MaxWidth="800"
                MaxHeight="600"
                HorizontalAlignment="Center"
                VerticalAlignment="Center">
            <Grid RowDefinitions="Auto,*,Auto">
                <TextBlock Grid.Row="0"
                           Text="{Binding FileBrowserTitle}"
                           Classes="header"
                           Margin="0,0,0,12"/>
                <views:FileBrowserGrid Grid.Row="1"
                                       DataContext="{Binding FileBrowserViewModel}"/>
                <StackPanel Grid.Row="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Spacing="8"
                            Margin="0,12,0,0">
                    <Button Content="Cancel"
                            Command="{Binding CloseFileBrowserCommand}"
                            FontSize="{DynamicResource EditorFontSizeSmall}"
                            Padding="16,8"/>
                </StackPanel>
            </Grid>
        </Border>
    </Border>

    <!-- Asset Editor Overlay -->
    <Border IsVisible="{Binding IsAssetEditorOpen}"
            Background="#C0000000">
        <Border Background="#E0202020"
                CornerRadius="8"
                BorderBrush="{DynamicResource PanelBorderBrush}"
                BorderThickness="1"
                Padding="20"
                Margin="60"
                MaxWidth="500"
                HorizontalAlignment="Center"
                VerticalAlignment="Center">
            <Grid RowDefinitions="Auto,*,Auto">
                <TextBlock Grid.Row="0"
                           Text="{Binding AssetEditorTitle}"
                           Classes="header"
                           Margin="0,0,0,16"/>

                <!-- Material Editor -->
                <StackPanel Grid.Row="1"
                            x:Name="MaterialEditorPanel"
                            Spacing="12">
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Name" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingAssetName}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Shader" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingAssetShader}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Albedo" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingAssetAlbedo}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Normal" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingAssetNormal}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Metallic" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingAssetMetallic}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Roughness" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingAssetRoughness}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                </StackPanel>

                <!-- Shader Editor -->
                <StackPanel Grid.Row="1"
                            x:Name="ShaderEditorPanel"
                            Spacing="12">
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Name" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingShaderName}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Type" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingShaderType}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Vertex Path" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingShaderVertexPath}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                    <Grid ColumnDefinitions="100,*">
                        <TextBlock Text="Pixel Path" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1" Text="{Binding EditingShaderPixelPath}" FontSize="{DynamicResource EditorFontSizeSmall}"/>
                    </Grid>
                </StackPanel>

                <StackPanel Grid.Row="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Spacing="8"
                            Margin="0,16,0,0">
                    <Button Content="Cancel"
                            Command="{Binding CloseAssetEditorCommand}"
                            FontSize="{DynamicResource EditorFontSizeSmall}"
                            Padding="16,8"/>
                    <Button Content="Save"
                            Command="{Binding SaveAssetEditorCommand}"
                            Classes="primary"
                            FontSize="{DynamicResource EditorFontSizeSmall}"
                            Padding="16,8"/>
                </StackPanel>
            </Grid>
        </Border>
    </Border>
    </Panel>
</UserControl>
