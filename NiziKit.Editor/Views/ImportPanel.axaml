<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:NiziKit.Editor.ViewModels"
             xmlns:views="using:NiziKit.Editor.Views"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             x:Class="NiziKit.Editor.Views.ImportPanel"
             x:DataType="vm:ImportViewModel">

    <Grid RowDefinitions="*,Auto" Margin="16">
        <!-- Main content: left (browser + queue) | right (details) -->
        <Grid Grid.Row="0" ColumnDefinitions="*,*" Margin="0,0,0,12">

            <!-- LEFT SIDE: File Browser (top) + Import Queue (bottom) -->
            <Grid Grid.Column="0" RowDefinitions="3*,Auto,2*" Margin="0,0,8,0">
                <!-- File Browser -->
                <Border Grid.Row="0"
                        Background="{DynamicResource EditorSurfaceRaised}"
                        BorderBrush="{DynamicResource EditorPanelBorder}"
                        BorderThickness="1"
                        Padding="12">
                    <views:FileBrowserGrid DataContext="{Binding FileBrowser}"/>
                </Border>

                <!-- Add to Queue button -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8" Margin="0,8">
                    <Button Content="Add to Queue"
                            Command="{Binding AddToQueueCommand}"
                            Padding="16,8"
                            Classes="accent"/>
                </StackPanel>

                <!-- Import Queue -->
                <Border Grid.Row="2"
                        Background="{DynamicResource EditorSurfaceRaised}"
                        BorderBrush="{DynamicResource EditorPanelBorder}"
                        BorderThickness="1"
                        Padding="12"
                        x:Name="ImportQueueBorder"
                        DragDrop.AllowDrop="True">
                    <Grid RowDefinitions="Auto,*">
                        <TextBlock Grid.Row="0"
                                   Text="Import Queue"
                                   Classes="subtitle"
                                   Margin="0,0,0,8"
                                   Foreground="{DynamicResource EditorTextSecondary}"/>
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding ImportItems}"
                                 SelectedItem="{Binding SelectedImportItem}"
                                 Background="Transparent"
                                 BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate x:DataType="vm:ImportAssetItemViewModel">
                                    <Grid ColumnDefinitions="*,Auto,Auto" Margin="4,2">
                                        <StackPanel Grid.Column="0" Spacing="2">
                                            <TextBlock Text="{Binding FileName}" FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding StatusText}"
                                                       Foreground="{DynamicResource EditorTextSecondary}"/>
                                        </StackPanel>
                                        <ProgressBar Grid.Column="1"
                                                     IsIndeterminate="True"
                                                     IsVisible="{Binding IsImporting}"
                                                     Width="40" Height="4"
                                                     VerticalAlignment="Center"
                                                     Margin="8,0"/>
                                        <Button Grid.Column="2"
                                                Command="{Binding $parent[ListBox].DataContext.RemoveFromQueueCommand}"
                                                CommandParameter="{Binding}"
                                                Padding="4"
                                                Classes="ghost"
                                                ToolTip.Tip="Remove">
                                            <ui:SymbolIcon Symbol="Dismiss" FontSize="{DynamicResource IconSizeXS}"/>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>
            </Grid>

            <!-- RIGHT SIDE: Asset Details for selected item -->
            <Border Grid.Column="1"
                    Background="{DynamicResource EditorSurfaceRaised}"
                    BorderBrush="{DynamicResource EditorPanelBorder}"
                    BorderThickness="1"
                    Padding="16"
                    Margin="8,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="12"
                                DataContext="{Binding SelectedImportItem}"
                                IsVisible="{Binding $parent[UserControl].DataContext.HasSelectedItem}">

                        <TextBlock Text="Asset Details" Classes="subtitle" Margin="0,0,0,4"/>

                        <!-- Asset Name -->
                        <Grid ColumnDefinitions="Auto,*" Margin="0,0,0,0">
                            <TextBlock Text="Asset Name"
                                       VerticalAlignment="Center"
                                       Classes="caption"
                                       MinWidth="140"
                                       Margin="0,0,12,0"/>
                            <TextBox Grid.Column="1" Text="{Binding AssetName}"/>
                        </Grid>

                        <!-- Output Subdirectory -->
                        <Grid ColumnDefinitions="Auto,*">
                            <TextBlock Text="Output Subdirectory"
                                       VerticalAlignment="Center"
                                       Classes="caption"
                                       MinWidth="140"
                                       Margin="0,0,12,0"/>
                            <TextBox Grid.Column="1"
                                     Text="{Binding OutputSubdirectory}"
                                     Watermark="(root output)"/>
                        </Grid>

                        <!-- Texture options -->
                        <StackPanel Spacing="8" IsVisible="{Binding IsTexture}">
                            <CheckBox Content="Generate Mipmaps" IsChecked="{Binding GenerateMips}"/>
                        </StackPanel>

                        <!-- Model: scanning indicator -->
                        <StackPanel Orientation="Horizontal" Spacing="8"
                                    IsVisible="{Binding IsScanning}">
                            <ProgressBar IsIndeterminate="True" Width="80" Height="4"/>
                            <TextBlock Text="Scanning..." Foreground="{DynamicResource EditorTextSecondary}"/>
                        </StackPanel>

                        <TextBlock Text="{Binding ScanError}"
                                   Foreground="{DynamicResource EditorError}"
                                   TextWrapping="Wrap"
                                   IsVisible="{Binding ScanError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                        <!-- Model: Meshes -->
                        <Expander Header="Meshes" IsExpanded="True"
                                  IsVisible="{Binding ScanComplete}">
                            <ItemsControl ItemsSource="{Binding Meshes}" Margin="8,4">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:MeshItemViewModel">
                                        <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,4">
                                            <CheckBox Grid.Column="0"
                                                      IsChecked="{Binding IsEnabled}"
                                                      Margin="0,0,8,0"/>
                                            <TextBox Grid.Column="1"
                                                     Text="{Binding ExportName}"
                                                     Padding="6,4"
                                                     MinWidth="120"/>
                                            <TextBlock Grid.Column="2"
                                                       Text="{Binding DisplayInfo}"
                                                       VerticalAlignment="Center"
                                                       Foreground="{DynamicResource EditorTextSecondary}"
                                                       Margin="12,0,0,0"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Expander>

                        <!-- Model: Skeleton -->
                        <Border IsVisible="{Binding HasSkeleton}"
                                Background="{DynamicResource EditorPanelSecondaryBackground}"
                                Padding="12,8"
                                Margin="0,4">
                            <Grid ColumnDefinitions="Auto,*">
                                <CheckBox Grid.Column="0"
                                          Content="Export Skeleton"
                                          IsChecked="{Binding ExportSkeleton}"/>
                                <TextBlock Grid.Column="1"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Right"
                                           Foreground="{DynamicResource EditorTextSecondary}">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0} joints, root: {1}">
                                            <Binding Path="JointCount"/>
                                            <Binding Path="RootJointName"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </Grid>
                        </Border>

                        <!-- Model: Animations -->
                        <Expander Header="Animations" IsExpanded="True"
                                  IsVisible="{Binding ScanComplete}">
                            <StackPanel Spacing="4" Margin="8,4">
                                <CheckBox Content="Export Animations"
                                          IsChecked="{Binding ExportAnimations}"
                                          Margin="0,0,0,4"/>
                                <ItemsControl ItemsSource="{Binding Animations}"
                                              IsEnabled="{Binding ExportAnimations}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="vm:AnimationItemViewModel">
                                            <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,4">
                                                <CheckBox Grid.Column="0"
                                                          IsChecked="{Binding IsEnabled}"
                                                          Margin="0,0,8,0"/>
                                                <TextBox Grid.Column="1"
                                                         Text="{Binding ExportName}"
                                                         Padding="6,4"
                                                         MinWidth="120"/>
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding DisplayInfo}"
                                                           VerticalAlignment="Center"
                                                           Foreground="{DynamicResource EditorTextSecondary}"
                                                           Margin="12,0,0,0"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Expander>

                        <!-- Model: Options -->
                        <Expander Header="Options" IsExpanded="False"
                                  IsVisible="{Binding ScanComplete}">
                            <StackPanel Spacing="8" Margin="8,4">
                                <Grid ColumnDefinitions="Auto,*">
                                    <TextBlock Text="Scale"
                                               VerticalAlignment="Center"
                                               Classes="caption"
                                               MinWidth="140"
                                               Margin="0,0,12,0"/>
                                    <TextBox Grid.Column="1" Text="{Binding Scale}" Width="90"
                                             HorizontalAlignment="Left"/>
                                </Grid>

                                <WrapPanel Orientation="Horizontal">
                                    <CheckBox Content="Optimize Meshes" IsChecked="{Binding OptimizeMeshes}" Margin="0,0,16,4"/>
                                    <CheckBox Content="Generate Normals" IsChecked="{Binding GenerateNormals}" Margin="0,0,16,4"/>
                                    <CheckBox Content="Tangents" IsChecked="{Binding CalculateTangents}" Margin="0,0,16,4"/>
                                    <CheckBox Content="Triangulate" IsChecked="{Binding TriangulateMeshes}" Margin="0,0,16,4"/>
                                    <CheckBox Content="Join Vertices" IsChecked="{Binding JoinIdenticalVertices}" Margin="0,0,16,4"/>
                                </WrapPanel>

                                <WrapPanel Orientation="Horizontal">
                                    <CheckBox Content="Smooth Normals" IsChecked="{Binding SmoothNormals}" Margin="0,0,16,4"/>
                                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                        <TextBlock Text="Angle:" VerticalAlignment="Center"
                                                   Classes="caption"/>
                                        <TextBox Text="{Binding SmoothNormalsAngle}" Width="60"/>
                                    </StackPanel>
                                </WrapPanel>

                                <WrapPanel Orientation="Horizontal">
                                    <CheckBox Content="Limit Bone Weights" IsChecked="{Binding LimitBoneWeights}" Margin="0,0,16,4"/>
                                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                        <TextBlock Text="Max:" VerticalAlignment="Center"
                                                   Classes="caption"/>
                                        <TextBox Text="{Binding MaxBoneWeightsPerVertex}" Width="60"/>
                                    </StackPanel>
                                </WrapPanel>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Bottom bar: output, progress, buttons -->
        <Border Grid.Row="1"
                Background="{DynamicResource EditorPanelSecondaryBackground}"
                Padding="18,14">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto,Auto">
                <TextBlock Text="Output Directory"
                           VerticalAlignment="Center"
                           Classes="caption"
                           Margin="0,0,12,0"/>
                <TextBox Grid.Column="1"
                         Text="{Binding OutputDirectory}"
                         Watermark="Assets/..."
                         VerticalAlignment="Center"/>

                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            VerticalAlignment="Center"
                            Spacing="14"
                            Margin="20,0"
                            IsVisible="{Binding IsImporting}">
                    <TextBlock Text="{Binding ProgressText}"
                               VerticalAlignment="Center"
                               MaxWidth="220"
                               TextTrimming="CharacterEllipsis"
                               Foreground="{DynamicResource EditorTextSecondary}"/>
                    <ProgressBar Value="{Binding Progress}"
                                 Maximum="100"
                                 Width="120"
                                 Height="6"
                                 VerticalAlignment="Center"/>
                </StackPanel>

                <TextBlock Grid.Column="3"
                           Text="{Binding ProgressText}"
                           Foreground="{DynamicResource EditorSuccess}"
                           VerticalAlignment="Center"
                           Margin="12,0"
                           IsVisible="{Binding ImportSucceeded}"/>

                <Button Grid.Column="4"
                        Content="Cancel"
                        Command="{Binding CancelCommand}"
                        Margin="12,0"
                        MinWidth="110"
                        Padding="18,12"/>
                <Button Grid.Column="5"
                        Content="Import All"
                        Command="{Binding ImportCommand}"
                        IsEnabled="{Binding !IsImporting}"
                        MinWidth="110"
                        Padding="18,12"
                        Classes="accent"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
